name: Generate Dynamic README

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œ
    - cron: '0 0 * * *'
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install axios moment
        
    - name: Create generate script
      run: |
        cat > generate-readme.js << 'EOF'
        const fs = require('fs');
        const axios = require('axios');
        const moment = require('moment');
        
        async function generateReadme() {
          const now = moment();
          const username = process.env.GITHUB_REPOSITORY.split('/')[0];
          
          let userInfo = {};
          try {
            const response = await axios.get('https://api.github.com/users/' + username);
            userInfo = response.data;
          } catch (error) {
            console.log('æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯:', error.message);
          }
          
          let recentRepos = [];
          try {
            const response = await axios.get('https://api.github.com/users/' + username + '/repos?sort=updated&per_page=5');
            recentRepos = response.data;
          } catch (error) {
            console.log('æ— æ³•è·å–ä»“åº“ä¿¡æ¯:', error.message);
          }
          
          const repoList = recentRepos.map(repo => 
            '- [' + repo.name + '](' + repo.html_url + ') - ' + (repo.description || 'æš‚æ— æè¿°')
          ).join('\n');
          
          const readme = '# Hi there! ğŸ‘‹\n\n' +
            '## å…³äºæˆ‘\n\n' +
            '**' + (userInfo.name || username) + '**\n' +
            (userInfo.bio || 'çƒ­çˆ±ç¼–ç¨‹çš„å¼€å‘è€…') + '\n\n' +
            '- ğŸŒ ä½ç½®: ' + (userInfo.location || 'åœ°çƒ') + '\n' +
            '- ğŸ¢ å…¬å¸: ' + (userInfo.company || 'è‡ªç”±èŒä¸š') + '\n' +
            '- ğŸ“§ é‚®ç®±: ' + (userInfo.email || 'æš‚æœªå…¬å¼€') + '\n' +
            '- ğŸ“± GitHub: [@' + username + '](https://github.com/' + username + ')\n' +
            '- ğŸ’¼ å…¬å¼€ä»“åº“: ' + (userInfo.public_repos || 0) + ' ä¸ª\n' +
            '- ğŸ‘¥ å…³æ³¨è€…: ' + (userInfo.followers || 0) + ' äºº\n\n' +
            '## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯\n\n' +
            '![GitHub Stats](https://github-readme-stats.vercel.app/api?username=' + username + '&show_icons=true&theme=radical)\n\n' +
            '## ğŸš€ æœ€è¿‘æ›´æ–°çš„é¡¹ç›®\n\n' +
            repoList + '\n\n' +
            '## ğŸ› ï¸ æŠ€æœ¯æ ˆ\n\n' +
            '![JavaScript](https://img.shields.io/badge/-JavaScript-F7DF1E?style=flat-square&logo=javascript&logoColor=black)\n' +
            '![Python](https://img.shields.io/badge/-Python-3776AB?style=flat-square&logo=python&logoColor=white)\n' +
            '![Node.js](https://img.shields.io/badge/-Node.js-339933?style=flat-square&logo=node.js&logoColor=white)\n' +
            '![React](https://img.shields.io/badge/-React-61DAFB?style=flat-square&logo=react&logoColor=black)\n' +
            '![Git](https://img.shields.io/badge/-Git-F05032?style=flat-square&logo=git&logoColor=white)\n\n' +
            '## ğŸ“ˆ è¯­è¨€ä½¿ç”¨ç»Ÿè®¡\n\n' +
            '![Top Languages](https://github-readme-stats.vercel.app/api/top-langs/?username=' + username + '&layout=compact&theme=radical)\n\n' +
            '## ğŸŒŸ \n\n' +
            '> "è·¯å¾ˆé•¿ï¼Œæ¢¦è¿˜åœ¨"\n\n' +
            '---\n\n' +
            'â° **æœ€åæ›´æ–°**: ' + now.format('YYYY-MM-DD HH:mm:ss') + ' UTC\n\n' +
            'ğŸ¤– **è‡ªåŠ¨ç”Ÿæˆ**: æœ¬ README é€šè¿‡ GitHub Actions è‡ªåŠ¨æ›´æ–°\n\n' +
            '[![GitHub Actions](https://img.shields.io/github/actions/workflow/status/' + process.env.GITHUB_REPOSITORY + '/readme.yml?branch=main)](https://github.com/' + process.env.GITHUB_REPOSITORY + '/actions)\n';
          
          fs.writeFileSync('README.md', readme);
          console.log('README.md ç”ŸæˆæˆåŠŸ!');
        }
        
        generateReadme().catch(console.error);
        EOF
        
    - name: Run generate script
      run: node generate-readme.js
        
    - name: Commit and push changes
      run: |
        git config --local user.email "IGCrystal@wenturc.com"
        git config --local user.name "IGCrystal"
        git add README.md
        git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° README - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
